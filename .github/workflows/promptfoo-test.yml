name: Promptfoo LLM Testing

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test-prompts:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Promptfoo
        run: npm install -g promptfoo

      - name: Run Promptfoo Tests
        id: promptfoo
        working-directory: ./fhdw_rag_demo/model_comparison
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        continue-on-error: true
        run: |
          echo "üß™ Running Promptfoo evaluation..."
          npx promptfoo eval --no-cache -o results.json --no-table
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Create Summary Card
        if: always()
        working-directory: ./fhdw_rag_demo/model_comparison
        run: |
          echo "# üß™ LLM Prompt Testing Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f results.json ]; then
            # Parse results
            TOTAL=$(cat results.json | jq '.results.stats.successes + .results.stats.failures')
            PASSED=$(cat results.json | jq '.results.stats.successes')
            FAILED=$(cat results.json | jq '.results.stats.failures')
            
            if [ "$FAILED" -gt 0 ]; then
              echo "## ‚ùå Tests Failed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> **$FAILED** of **$TOTAL** tests failed. Your prompts need improvement!" >> $GITHUB_STEP_SUMMARY
            else
              echo "## ‚úÖ All Tests Passed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> **$PASSED** of **$TOTAL** tests passed. Your prompts are production-ready!" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üìä Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ‚úÖ Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚ùå Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| üìã Total | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "*Powered by [Promptfoo](https://promptfoo.dev) - LLM Testing Framework*" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ö†Ô∏è No Results Found" >> $GITHUB_STEP_SUMMARY
            echo "The evaluation may have failed to run." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if tests failed
        if: steps.promptfoo.outcome == 'failure'
        run: |
          echo "‚ùå Promptfoo tests failed!"
          exit 1
