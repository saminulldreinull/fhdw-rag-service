name: FHDW RAG Service - Prompt Security Testing

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test-prompts:
    name: RAG Security Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Promptfoo
        run: npm install -g promptfoo

      - name: Run RAG Security Tests
        id: promptfoo
        working-directory: ./fhdw_rag_demo/model_comparison
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        continue-on-error: true
        run: |
          echo "ðŸ”’ Running FHDW RAG Security Tests..."
          npx promptfoo eval --no-cache -o results.json --no-table
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Create Security Report
        if: always()
        working-directory: ./fhdw_rag_demo/model_comparison
        run: |
          echo "# ðŸŽ“ FHDW RAG Service - Security Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f results.json ]; then
            TOTAL=$(cat results.json | jq '.results.stats.successes + .results.stats.failures')
            PASSED=$(cat results.json | jq '.results.stats.successes')
            FAILED=$(cat results.json | jq '.results.stats.failures')
            
            if [ "$FAILED" -gt 0 ]; then
              echo "## ðŸš¨ Security Vulnerability Detected" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> **$FAILED** of **$TOTAL** prompts are vulnerable to injection attacks!" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### âš ï¸ Action Required" >> $GITHUB_STEP_SUMMARY
              echo "The RAG Service contains prompts that can be manipulated. Do NOT deploy to production!" >> $GITHUB_STEP_SUMMARY
            else
              echo "## âœ… All Security Tests Passed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> All **$PASSED** prompts are resistant to injection attacks. Ready for production!" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“Š Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Secure Prompts | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸš¨ Vulnerable Prompts | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“‹ Total | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“š *FHDW - Software Engineering & DevOps | Automatisierte LLM-Sicherheitstests*" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸ Test Execution Failed" >> $GITHUB_STEP_SUMMARY
            echo "Could not run security tests. Check the logs for details." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Block Deployment if Vulnerable
        if: steps.promptfoo.outcome == 'failure'
        run: |
          echo "ðŸš¨ SECURITY ALERT: Vulnerable prompts detected! Blocking deployment."
          exit 1
