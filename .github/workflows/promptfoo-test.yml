name: FHDW RAG Service - Prompt Security Testing

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # ErmÃ¶glicht manuelles Starten fÃ¼r Live-Demo

jobs:
  security-tests:
    name: ğŸ”’ RAG Security Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install Promptfoo
        run: npm install -g promptfoo

      - name: ğŸ§ª Run Security Tests
        id: promptfoo
        working-directory: ./fhdw_rag_demo/model_comparison
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        continue-on-error: true
        run: |
          echo "ğŸ”’ Running FHDW RAG Security Tests..."
          npx promptfoo eval --no-cache -o results.json --no-table
          
          # Save results for later steps
          if [ -f results.json ]; then
            PASSED=$(cat results.json | jq '.results.stats.successes')
            FAILED=$(cat results.json | jq '.results.stats.failures')
            echo "passed=$PASSED" >> $GITHUB_OUTPUT
            echo "failed=$FAILED" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“Š Create Security Report
        if: always()
        working-directory: ./fhdw_rag_demo/model_comparison
        run: |
          echo "# ğŸ“ FHDW RAG Service - Security Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f results.json ]; then
            TOTAL=$(cat results.json | jq '.results.stats.successes + .results.stats.failures')
            PASSED=$(cat results.json | jq '.results.stats.successes')
            FAILED=$(cat results.json | jq '.results.stats.failures')
            
            if [ "$FAILED" -gt 0 ]; then
              echo "## ğŸš¨ Security Vulnerability Detected" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> **$FAILED** of **$TOTAL** prompts are vulnerable to injection attacks!" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### âš ï¸ Deployment Blocked" >> $GITHUB_STEP_SUMMARY
              echo "This commit contains prompts that can be manipulated by malicious users." >> $GITHUB_STEP_SUMMARY
              echo "**A security issue has been automatically created.**" >> $GITHUB_STEP_SUMMARY
            else
              echo "## âœ… All Security Tests Passed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> All **$PASSED** prompts are resistant to injection attacks." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ğŸš€ Ready for Production" >> $GITHUB_STEP_SUMMARY
              echo "This commit is safe to deploy." >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“Š Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Secure Prompts | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸš¨ Vulnerable Prompts | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ“‹ Total Tests | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“š *FHDW Bielefeld | Software Engineering & DevOps*" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸš¨ Create Security Issue
        if: steps.promptfoo.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const failed = '${{ steps.promptfoo.outputs.failed }}' || 'unknown';
            const passed = '${{ steps.promptfoo.outputs.passed }}' || 'unknown';
            
            const issueBody = `## ğŸš¨ Security Vulnerability Detected

            ### Summary
            A security scan has detected **${failed} vulnerable prompt(s)** in the RAG Service.

            ### Details
            | Metric | Value |
            |--------|-------|
            | âœ… Secure Prompts | ${passed} |
            | ğŸš¨ Vulnerable Prompts | ${failed} |
            | ğŸ“Œ Commit | \`${{ github.sha }}\` |
            | ğŸ”— Branch | \`${{ github.ref_name }}\` |
            | ğŸ”„ Workflow Run | [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |

            ### Risk Assessment
            âš ï¸ **HIGH RISK** - The naive prompt is vulnerable to:
            - RAG Poisoning attacks
            - Data manipulation
            - Unauthorized grade changes

            ### Recommended Actions
            1. Review the failing test cases in the workflow run
            2. Update \`prompt_naive.txt\` with proper guardrails
            3. Re-run the security tests

            ---
            *This issue was automatically created by the FHDW RAG Security Pipeline*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Security Alert: Vulnerable Prompts Detected',
              body: issueBody,
              labels: ['security', 'prompt-injection', 'high-priority']
            });

      - name: âŒ Block Deployment
        if: steps.promptfoo.outcome == 'failure'
        run: |
          echo "ğŸš¨ SECURITY ALERT: Deployment blocked due to vulnerable prompts!"
          exit 1
